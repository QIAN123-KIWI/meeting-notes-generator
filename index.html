<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…šæ€»æ”¯ä¼šè®®çºªè¦ç³»ç»Ÿ (è¡¨æ ¼æ ‡é¢˜ç»ˆæä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        body { font-family: 'Noto Serif SC', serif; background-color: #f3f4f6; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #b91c1c;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input.custom-input { width: 100%; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; border-radius: 0.375rem; }
        input.custom-input:focus { border-color: #ef4444; outline: none; ring: 1px solid #ef4444; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼šè®®çºªè¦æ’°å†™åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä¸‹åˆ—è§„åˆ™ç”Ÿæˆä¼šè®®çºªè¦æ­£æ–‡ï¼š
ã€ç¼–å·ä¸æ ¼å¼ã€‘
- æ‰€æœ‰çºªè¦æ¡ç›®ä½¿ç”¨ä¸­æ–‡æ•°å­—ï¼ˆä¸€ã€äºŒã€ä¸‰â€¦â€¦ï¼‰ç¼–å·ï¼Œå•ç‹¬æˆæ®µã€‚
- ä¸è¦ä½¿ç”¨ Markdown æ ¼å¼ï¼Œåªè¾“å‡ºçº¯æ–‡æœ¬ã€‚
- è®®é¢˜å’Œæ­£æ–‡è¯·ä½¿ç”¨ä»¿å®‹_GB2312 ä¸‰å·å­—ä½“ã€‚
ã€åŠ¨è¯è½¬æ¢ä½“ç³»ã€‘
- å¸¸è§åŠ¨è¯ï¼šå®¡è®®ï¼ˆè½¬æ¢ä¸ºï¼šä¼šè®®åŒæ„ï¼‰ã€å¬å–ï¼ˆè½¬æ¢ä¸ºï¼šä¼šè®®åŒæ„æˆ–ä¼šè®®å¬å–ï¼‰ã€å­¦ä¹ ï¼ˆè½¬æ¢ä¸ºï¼šä¼šè®®å­¦ä¹ äº†ï¼‰
- å¿…é¡»è½¬æ¢ï¼šå¦‚æœåŸæ–‡æ˜¯â€œå®¡è®®ã€ŠXXXã€‹â€ï¼Œçºªè¦ä¸­å¿…é¡»å†™â€œä¼šè®®å®¡è®®ã€ŠXXXã€‹ã€‚ä¼šè®®åŒæ„è¯¥...â€ã€‚
- æ±‡æŠ¥äººæˆ–é¢†å­¦äººä¿¡æ¯è¯·å•ç‹¬æˆè¡Œã€‚
ã€å†³è®®ä¸ä»»åŠ¡åˆ†é…ã€‘
- å¸¸ç”¨å†³è®®ï¼šä¼šè®®åŒæ„ã€ä¼šè®®è¦æ±‚ã€‚
- å¸¸ç”¨ä»»åŠ¡åˆ†é…ï¼šè¦æ±‚ç»¼åˆåŠå…¬å®¤ï¼ˆç»å¤§å¤šæ•°æƒ…å†µï¼‰ã€æè¯·åŠå…¬ä¼šè®®å®¡è®®ã€‚
- ç¦æ­¢å†™â€œå„éƒ¨é—¨â€ï¼Œåªèƒ½å†™â€œç»¼åˆåŠå…¬å®¤â€æˆ–â€œè®¡åˆ’è´¢åŠ¡éƒ¨â€ã€‚
ã€ä¸‰æ®µå¼ç»“æ„ã€‘
- æ¯æ¡çºªè¦åº”åŒ…å«ï¼š
  1. åŠ¨è¯è½¬æ¢åçš„è®®é¢˜å¤è¿°
  2. æ˜ç¡®çš„ä¼šè®®å†³è®®
  3. æ¸…æ™°çš„ä»»åŠ¡åˆ†é…ä¸è¦æ±‚
è¯·åªè¾“å‡ºç”Ÿæˆçš„æ­£æ–‡å†…å®¹ï¼Œä¸è¦åŒ…å«æ ‡é¢˜ã€åŸºæœ¬ä¿¡æ¯æˆ–è®®é¢˜åˆ—è¡¨ã€‚`;

        // --- æ ¸å¿ƒè¡¨æ ¼ XML (åªåŒ…å«è¡¨æ ¼æœ¬èº«ï¼Œä¸å«æ ‡é¢˜å’Œç©ºè¡Œ) ---
        const TABLE_XML_TEMPLATE = `
        <w:tbl>
            <w:tblPr>
                <w:tblStyle w:val="TableGrid"/>
                <w:tblW w:w="9490" w:type="dxa"/>
                <w:tblBorders>
                    <w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                    <w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                    <w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                    <w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                    <w:insideH w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                    <w:insideV w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                </w:tblBorders>
                <w:tblLook w:val="04A0" w:firstRow="1" w:lastRow="0" w:firstColumn="1" w:lastColumn="0" w:noHBand="0" w:noVBand="1"/>
            </w:tblPr>
            <w:tblGrid>
                <w:gridCol w:w="3163"/>
                <w:gridCol w:w="3163"/>
                <w:gridCol w:w="3164"/>
            </w:tblGrid>
            <!-- ç¬¬ä¸€è¡Œ: è¡¨å¤´ -->
            <w:tr>
                <w:tc>
                    <w:tcPr>
                        <w:tcW w:w="3163" w:type="dxa"/>
                        <w:vAlign w:val="center"/>
                    </w:tcPr>
                    <w:p>
                        <w:pPr>
                            <w:jc w:val="center"/>
                            <w:rPr><w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/><w:sz w:val="32"/></w:rPr>
                        </w:pPr>
                        <w:r><w:rPr><w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/><w:sz w:val="32"/></w:rPr><w:t>æ€»æ”¯å§”å§”å‘˜</w:t></w:r>
                    </w:p>
                </w:tc>
                <w:tc>
                    <w:tcPr>
                        <w:tcW w:w="3163" w:type="dxa"/>
                        <w:vAlign w:val="center"/>
                    </w:tcPr>
                    <w:p>
                        <w:pPr><w:jc w:val="center"/><w:rPr><w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/><w:sz w:val="32"/></w:rPr></w:pPr>
                        <w:r><w:rPr><w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/><w:sz w:val="32"/></w:rPr><w:t>é¢†å¯¼é˜…ç­¾</w:t></w:r>
                    </w:p>
                </w:tc>
                <w:tc>
                    <w:tcPr>
                        <w:tcW w:w="3164" w:type="dxa"/>
                        <w:vAlign w:val="center"/>
                    </w:tcPr>
                    <w:p>
                        <w:pPr><w:jc w:val="center"/><w:rPr><w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/><w:sz w:val="32"/></w:rPr></w:pPr>
                        <w:r><w:rPr><w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/><w:sz w:val="32"/></w:rPr><w:t>æ—¥æœŸ</w:t></w:r>
                    </w:p>
                </w:tc>
            </w:tr>
            <w:tr>
                <w:tc><w:tcPr><w:tcW w:w="3163" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:t>è‡§ å</w:t></w:r></w:p></w:tc>
                <w:tc><w:tcPr><w:tcW w:w="3163" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p/></w:tc>
                <w:tc><w:tcPr><w:tcW w:w="3164" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p/></w:tc>
            </w:tr>
            <w:tr>
                <w:tc><w:tcPr><w:tcW w:w="3163" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:t>å­™äº¦ä¼Ÿ</w:t></w:r></w:p></w:tc>
                <w:tc><w:tcPr><w:tcW w:w="3163" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p/></w:tc>
                <w:tc><w:tcPr><w:tcW w:w="3164" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p/></w:tc>
            </w:tr>
        </w:tbl>`;
        // --- æ ¸å¿ƒè¡¨æ ¼ XML ç»“æŸ ---
        
        // ç”¨äºå­˜å‚¨ä»æ¯ç‰ˆä¸­è§£æå‡ºçš„æ ·å¼ä¿¡æ¯
        let globalStyle = {
            pPr: '', // æ®µè½å±æ€§ï¼ŒåŒ…å«ç¼©è¿›ã€å¯¹é½ç­‰
            rPr: ''  // å­—ç¬¦å±æ€§ï¼ŒåŒ…å«å­—ä½“ã€å­—å·ç­‰
        };


        const App = () => {
            const apiKey = "sk-d8f9d80c5d154e5fa8ce9413560ccfe8"; 
            
            const [replaceMap, setReplaceMap] = useState({
                issue: { label: "æ–‡å·", old: "", new: "2025ï¼16" },
                date: { label: "æ—¥æœŸ", old: "", new: new Date().toLocaleDateString('zh-CN', {year:'numeric', month:'long', day:'numeric'}) },
                time: { label: "æ—¶é—´", old: "", new: "" },
                location: { label: "åœ°ç‚¹", old: "", new: "" },
                attendees: { label: "å‡ºå¸­", old: "", new: "" },
                nonvoting: { label: "åˆ—å¸­", old: "", new: "" },
                host: { label: "ä¸»æŒ", old: "", new: "" },
                recorder: { label: "è®°å½•", old: "", new: "" },
            });

            const [inputText, setInputText] = useState("");
            const [generatedContent, setGeneratedContent] = useState("");
            
            const [templateBuffer, setTemplateBuffer] = useState(null);
            const [fileName, setFileName] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState("è¯·å…ˆä¸Šä¼ æ—§æ–‡æ¡£ä½œä¸ºæ¯ç‰ˆ");
            const [proxyService, setProxyService] = useState("lineA");

            const updateMap = (key, field, val) => {
                setReplaceMap(prev => ({
                    ...prev,
                    [key]: { ...prev[key], [field]: val }
                }));
            };

            // è¾…åŠ©å‡½æ•°ï¼šæå–æ¯ç‰ˆæ ·å¼
            const extractStyleFromXml = (xml) => {
                const ANCHOR_BODY_START = "ä¸€ã€";
                const textIndex = xml.indexOf(ANCHOR_BODY_START);
                if (textIndex === -1) return;

                // æ‰¾åˆ° "ä¸€ã€" æ‰€åœ¨çš„ <w:p> æ®µè½ XML
                const pStart = xml.lastIndexOf("<w:p", textIndex);
                const pEnd = xml.indexOf("</w:p>", textIndex) + 6; 
                if (pStart === -1 || pEnd === 5) return;
                
                const pXml = xml.substring(pStart, pEnd);

                // 1. æå– <w:pPr> æ®µè½å±æ€§ (åŒ…å«æ ·å¼ã€ç¼©è¿›ç­‰)
                const pPrMatch = pXml.match(/<w:pPr>(.*?)<\/w:pPr>/);
                globalStyle.pPr = pPrMatch ? pPrMatch[1] : '';

                // 2. æå– <w:rPr> å­—ç¬¦å±æ€§ (åŒ…å«å­—ä½“ã€å­—å·ç­‰)
                const rPrMatch = pXml.match(/<w:rPr>(.*?)<\/w:rPr>/);
                globalStyle.rPr = rPrMatch ? rPrMatch[1] : '';
                
                // ç¡®ä¿è‡³å°‘æœ‰é»˜è®¤å­—å·å’Œå­—ä½“ï¼Œå¦åˆ™ç”¨ç¡¬ç¼–ç çš„ä»¿å®‹ä¸‰å·
                if (!globalStyle.rPr) {
                     globalStyle.rPr = `<w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/><w:sz w:val="32"/><w:szCs w:val="32"/>`;
                } else {
                    // ç¡®ä¿ eastAsia å±æ€§æ˜¯ "ä»¿å®‹" (è§£å†³ä»¿å®‹_GB2312 ç¼–ç é—®é¢˜)
                    globalStyle.rPr = globalStyle.rPr.replace(/w:eastAsia="[^"]*"/, 'w:eastAsia="ä»¿å®‹"');
                    if (!globalStyle.rPr.includes('w:eastAsia')) {
                        globalStyle.rPr += ` w:eastAsia="ä»¿å®‹"`;
                    }
                }

                // ç¡®ä¿æœ‰é¦–è¡Œç¼©è¿›
                if (!globalStyle.pPr || !globalStyle.pPr.includes("<w:ind")) {
                     globalStyle.pPr += `<w:ind w:firstLine="560" w:firstLineChars="200"/>`;
                }
            };
            
            const handleParseOldDoc = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);
                setStatusMsg("æ­£åœ¨æ·±åº¦è§£ææ—§æ–‡æ¡£...");
                const arrayBuffer = await file.arrayBuffer();
                setTemplateBuffer(arrayBuffer);

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const result = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                        const text = result.value;
                        
                        // ä»åŸå§‹ XML ä¸­æå–æ ·å¼
                        const xml = new window.PizZip(arrayBuffer).file("word/document.xml").asText();
                        extractStyleFromXml(xml);

                        const extract = (regex) => {
                            const match = text.match(regex);
                            return match ? match[1].trim() : "";
                        };

                        const newMap = { ...replaceMap };
                        const setVal = (key, regex) => {
                            const val = extract(regex);
                            if (val) {
                                newMap[key].old = val;
                                newMap[key].new = val; 
                            }
                        };
                        setVal('issue', /ï¼ˆ(20\d\d[ï¼-]\d+)ï¼‰/);
                        setVal('date', /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)/);
                        setVal('time', /æ—¶é—´[ï¼š:]\s*(.*)/);
                        setVal('location', /åœ°ç‚¹[ï¼š:]\s*(.*)/);
                        setVal('attendees', /å‡ºå¸­[ï¼š:]\s*(.*)/);
                        setVal('nonvoting', /åˆ—å¸­[ï¼š:]\s*(.*)/);
                        setVal('host', /ä¸»æŒ[ï¼š:]\s*(.*)/);
                        setVal('recorder', /è®°å½•[ï¼š:]\s*(.*)/);
                        setReplaceMap(newMap);
                        setStatusMsg("âœ… æ¯ç‰ˆåŠ è½½æˆåŠŸï¼å·²ç»§æ‰¿æ­£æ–‡æ ¼å¼ã€‚");
                    } catch (error) {
                        console.error(error);
                        setStatusMsg("âŒ è§£æå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æ—§å†…å®¹ã€‚");
                    }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = null;
            };

            const handleGenerateAI = async () => {
                if (!apiKey) { alert("è¯·åœ¨ä»£ç ä¸­å¡«å…¥æ‚¨çš„ API Keyï¼"); return; }
                if (!inputText.trim()) { alert("è¯·è¾“å…¥è®®é¢˜å†…å®¹ï¼"); return; }
                setIsLoading(true);
                let lineName = "æœªçŸ¥";
                if(proxyService === "lineA") lineName = "çº¿è·¯A";
                if(proxyService === "lineB") lineName = "çº¿è·¯B";
                if(proxyService === "lineC") lineName = "çº¿è·¯C";
                if(proxyService === "direct") lineName = "ç›´è¿";
                
                setStatusMsg(`æ­£åœ¨å°è¯•è¿æ¥ (${lineName})...`);
                
                try {
                    const targetUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
                    let finalUrl = "";
                    let headers = { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` };

                    if (proxyService === "lineA") {
                        finalUrl = "https://cors-anywhere.herokuapp.com/" + targetUrl;
                        headers["X-Requested-With"] = "XMLHttpRequest"; 
                    } else if (proxyService === "lineB") {
                        finalUrl = "https://corsproxy.io/?" + encodeURIComponent(targetUrl);
                    } else if (proxyService === "lineC") {
                        finalUrl = "https://thingproxy.freeboard.io/fetch/" + targetUrl;
                    } else {
                        finalUrl = targetUrl;
                    }

                    const response = await fetch(finalUrl, {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            model: "qwen-max",
                            messages: [
                                { role: "system", content: SYSTEM_PROMPT },
                                { role: "user", content: `ã€å®é™…ä¼šè®®è®®é¢˜å†…å®¹ã€‘\n${inputText}` }
                            ]
                        })
                    });

                    if (response.status === 403 && proxyService === "lineA") {
                        throw new Error("NEED_ACTIVATION");
                    }

                    const data = await response.json();
                    if (response.ok && data.choices) {
                        setGeneratedContent(data.choices[0].message.content);
                        setStatusMsg("âœ… AI ç”Ÿæˆå®Œæˆï¼è¯·ç‚¹å‡»å¯¼å‡ºã€‚");
                    } else {
                        throw new Error(data.message || "API Error");
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                    if (error.message === "NEED_ACTIVATION") {
                        setStatusMsg("âš ï¸ çº¿è·¯Aéœ€æ¿€æ´»ï¼è¯·ç‚¹å‡»ä¸‹æ–¹çº¢è‰²é“¾æ¥ã€‚");
                        alert("ğŸ”´ çº¿è·¯A æœªæ¿€æ´»ï¼\n\nè¯·ç‚¹å‡»é¡µé¢å³ä¸‹æ–¹çš„ã€ğŸ‘‰ ç‚¹æ­¤æ¿€æ´»çº¿è·¯Aã€‘é“¾æ¥ã€‚");
                    } else {
                        setStatusMsg(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
                    }
                } finally { setIsLoading(false); }
            };

            // æ ¸å¿ƒï¼šæ„é€  Word XML æ®µè½ (åº”ç”¨ç»§æ‰¿æ ·å¼)
            const makeParagraphXml = (text, alignment = 'left') => {
                let pPrContent = globalStyle.pPr || '';
                let rPrContent = globalStyle.rPr || '';
                const trimmed = text.trim();
                
                let jcTag = '';
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ±‡æŠ¥äºº/é¢†å­¦äººï¼Œå¼ºåˆ¶å³å¯¹é½
                if (trimmed.startsWith("æ±‡æŠ¥ï¼š") || trimmed.startsWith("é¢†å­¦ï¼š") || trimmed.startsWith("æ±‡æŠ¥:")) {
                    jcTag = '<w:jc w:val="right"/>';
                    // ç§»é™¤æ®µè½ä¸­çš„é¦–è¡Œç¼©è¿›ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç¡®ä¿å³å¯¹é½ä¸å—å¹²æ‰°
                    pPrContent = pPrContent.replace(/<w:ind[^>]*>/g, ''); 
                } else {
                    jcTag = '<w:jc w:val="left"/>';
                }

                return `<w:p>
                    <w:pPr>
                        ${jcTag}
                        ${pPrContent}
                    </w:pPr>
                    <w:r>
                        <w:rPr>
                            ${rPrContent}
                        </w:rPr>
                        <w:t>${text}</w:t>
                    </w:r>
                </w:p>`;
            };

            // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆç©ºç™½è¡Œ (w:line="480" å¯¹åº” Word çš„å•å€è¡Œè·)
            const makeBlankLineXml = (count = 1) => {
                let xml = '';
                for (let i = 0; i < count; i++) {
                    // ä½¿ç”¨ç©ºçš„ <w:p> æ ‡ç­¾å®ç°ç©ºè¡Œï¼Œå¹¶ç¡®ä¿å…¶è¡Œé«˜ä¸ºå•å€è¡Œè· (480)
                    // æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†ä¿è¯å’Œæ­£æ–‡æ ¼å¼ç»Ÿä¸€ï¼Œå¯ä»¥ä¹Ÿç»§æ‰¿ pPr
                    xml += `<w:p><w:pPr><w:spacing w:line="480" w:lineRule="auto"/>${globalStyle.pPr.replace(/<w:ind[^>]*>/g, '')}</w:pPr></w:p>`;
                }
                return xml;
            };

            const findParagraphBounds = (xml, searchText, startIndex = 0) => {
                const textIndex = xml.indexOf(searchText, startIndex);
                if (textIndex === -1) return null;
                const pStart = xml.lastIndexOf("<w:p", textIndex);
                const pEnd = xml.indexOf("</w:p>", textIndex) + 6; 
                if (pStart === -1 || pEnd === 5) return null;
                return { start: pStart, end: pEnd, textIndex: textIndex };
            };

            const exportDoc = () => {
                if (!templateBuffer) { alert("è¯·å…ˆä¸Šä¼ æ¯ç‰ˆï¼"); return; }
                
                try {
                    const zip = new window.PizZip(templateBuffer);
                    let xmlStr = zip.file("word/document.xml").asText();
                    
                    const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const createXmlRegex = (pt) => {
                        if (!pt) return null;
                        const pattern = pt.split('').map(c => escapeRegExp(c)).join('(?:<[^>]+>)*');
                        return new RegExp(pattern, 'g');
                    };

                    // 1. åŸºç¡€ä¿¡æ¯æ›¿æ¢ (æ—¥æœŸã€åœ°ç‚¹ç­‰)
                    Object.values(replaceMap).forEach(item => {
                        if (item.old && item.new && item.old !== item.new) {
                            const regex = createXmlRegex(item.old);
                            if (regex) xmlStr = xmlStr.replace(regex, item.new);
                        }
                    });

                    // 2. æ ¸å¿ƒæ‰‹æœ¯ï¼šè®®é¢˜/æ­£æ–‡æ›¿æ¢ï¼Œæ’å…¥é‡å»ºçš„è¡¨æ ¼
                    if (generatedContent && inputText) {
                        
                        const newAgendaXml = inputText.split('\n')
                            .filter(line => line.trim())
                            .map(line => makeParagraphXml(line.trim())) 
                            .join('');

                        const newBodyXml = generatedContent.split('\n')
                            .filter(line => line.trim())
                            .map(line => makeParagraphXml(line.trim()))
                            .join('');
                        
                        // --- æ„é€ æœ€ç»ˆå†…å®¹å— ---
                        const middleBlankLine = makeBlankLineXml(1);
                        const footerBlankLines = makeBlankLineXml(3); 

                        // è¡¨æ ¼æ ‡é¢˜ XML (ä»…ä¿ç•™æ ‡é¢˜æœ¬èº«)
                        const tableTitleXml = `<w:p>
                            <w:pPr>
                                <w:jc w:val="center"/>
                                <w:spacing w:line="480" w:lineRule="auto"/>
                            </w:pPr>
                            <w:r>
                                <w:rPr>
                                    <w:rFonts w:ascii="FangSong" w:eastAsia="ä»¿å®‹" w:hAnsi="FangSong"/>
                                    <w:sz w:val="32"/>
                                    <w:szCs w:val="32"/>
                                    <w:b/>
                                </w:rPr>
                                <w:t>æ€»æ”¯å§”ä¼šçºªè¦é˜…ç­¾å•</w:t>
                            </w:r>
                        </w:p>`;
                        
                        // ç»ˆææ‹¼æ¥ï¼šæ–°è®®é¢˜ + 1ç©ºè¡Œ + æ–°æ­£æ–‡ + 3ç©ºè¡Œ + è¡¨æ ¼æ ‡é¢˜ + è¡¨æ ¼ä¸»ä½“
                        const newContentBlock = 
                            newAgendaXml + 
                            middleBlankLine + 
                            newBodyXml + 
                            footerBlankLines + 
                            tableTitleXml + 
                            TABLE_XML_TEMPLATE; 

                        const ANCHOR_AGENDA = "è®®é¢˜ï¼š";
                        const ANCHOR_BODY_START = "ä¸€ã€";

                        const posAgenda = findParagraphBounds(xmlStr, ANCHOR_AGENDA);
                        const posBodyStart = findParagraphBounds(xmlStr, ANCHOR_BODY_START, posAgenda ? posAgenda.end : 0);
                        
                        // å¯»æ‰¾æ–‡æ¡£ç»“æŸæ ‡ç­¾çš„èµ·å§‹ä½ç½®
                        const bodyEndTagStart = xmlStr.lastIndexOf("</w:body>"); 

                        if (posAgenda && posBodyStart && bodyEndTagStart !== -1) {
                            
                            // 1. å¤´éƒ¨ï¼šä»æ–‡æ¡£å¼€å§‹åˆ° "è®®é¢˜ï¼š" æ®µè½ç»“æŸ (ä¿ç•™ "è®®é¢˜ï¼š"è¿™ä¸‰ä¸ªå­—)
                            const replaceStart = posAgenda.end; 
                            const partHeader = xmlStr.substring(0, replaceStart);
                            
                            // 2. å°¾éƒ¨ï¼šä» bodyEndTagStart åˆ°æ–‡æ¡£æœ«å°¾ (ä¿ç•™ </w:body> å’Œ </w:document>)
                            const partFooter = xmlStr.substring(bodyEndTagStart);

                            // 3. æ›¿æ¢åŒºåŸŸï¼šä» replaceStart åˆ° bodyEndTagStart ä¹‹é—´çš„æ‰€æœ‰æ—§å†…å®¹
                            xmlStr = partHeader + newContentBlock + partFooter;

                            alert("âœ… æˆåŠŸï¼\n\næ–°å†…å®¹å·²åº”ç”¨æ¯ç‰ˆæ ¼å¼å¹¶å®Œå…¨æ›¿æ¢æ—§å†…å®¹ã€‚\næ’ç‰ˆå·²ä¿®æ­£ï¼šè®®é¢˜/æ­£æ–‡ç©ºä¸€è¡Œï¼Œæ­£æ–‡/è¡¨æ ¼ç©ºä¸‰è¡Œï¼Œå¹¶åŠ å…¥äº†è¡¨æ ¼æ ‡é¢˜ã€‚\n");

                        } else {
                            alert("âš ï¸ å®šä½å¤±è´¥ã€‚è¯·ç¡®ä¿æ¯ç‰ˆä¸­åŒ…å«â€œè®®é¢˜ï¼šâ€å’Œâ€œä¸€ã€â€è¿™ä¸¤ä¸ªå…³é”®è¯ã€‚");
                        }
                    }

                    zip.file("word/document.xml", xmlStr);
                    const blob = zip.generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                    saveAs(blob, `ä¼šè®®çºªè¦_${replaceMap.issue.new}.docx`);
                    setStatusMsg("ğŸ‰ å¯¼å‡ºæˆåŠŸï¼");

                } catch (e) {
                    console.error(e);
                    alert("å¯¼å‡ºå¤±è´¥: " + e.message);
                }
            };

            return (
                <div className="max-w-7xl mx-auto p-6 min-h-screen text-gray-800 font-sans">
                    <div className="bg-white p-8 rounded-xl shadow-xl border border-gray-200">
                        <div className="flex justify-between items-center border-b pb-4 mb-6">
                            <h1 className="text-2xl font-bold text-red-700">å…šæ€»æ”¯ä¼šè®®çºªè¦ç³»ç»Ÿ (æ ·å¼ç»§æ‰¿ç»ˆæç‰ˆ)</h1>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* å·¦ä¾§ */}
                            <div className="lg:col-span-7 space-y-6">
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-blue-800 text-lg">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ—§æ–‡æ¡£æ¯ç‰ˆ</h3>
                                        <p className="text-xs text-blue-600">{fileName ? `å½“å‰æ¯ç‰ˆï¼š${fileName}` : "è¯·ä¸Šä¼ ä¸Šæ¬¡çš„ .docx æ–‡ä»¶ï¼Œç³»ç»Ÿå°†ä¿ç•™å…¶æ ¼å¼"}</p>
                                    </div>
                                    <label className="cursor-pointer bg-white text-blue-700 border border-blue-300 px-4 py-2 rounded shadow hover:bg-blue-50 font-bold text-sm">
                                        ğŸ“‚ ç‚¹å‡»ä¸Šä¼ 
                                        <input type="file" className="hidden" onChange={handleParseOldDoc} accept=".docx"/>
                                    </label>
                                </div>

                                <div className="bg-white border border-gray-200 rounded-lg p-4">
                                    <h3 className="font-bold text-gray-700 mb-3 border-l-4 border-red-500 pl-2">ç¬¬äºŒæ­¥ï¼šç¡®è®¤æ›¿æ¢å†…å®¹</h3>
                                    <div className="grid grid-cols-1 gap-3 max-h-[400px] overflow-y-auto pr-2">
                                        {Object.entries(replaceMap).map(([key, val]) => (
                                            <div key={key} className="flex items-center bg-gray-50 p-2 rounded">
                                                <div className="w-16 text-xs font-bold text-gray-600">{val.label}</div>
                                                <div className="flex-1">
                                                    <div className="text-xs text-gray-400 mb-1">æ—§: {val.old || "(æœªæ‰¾åˆ°)"}</div>
                                                    <input 
                                                        className="custom-input h-8 text-sm" 
                                                        value={val.new} 
                                                        onChange={(e) => updateMap(key, 'new', e.target.value)}
                                                        placeholder={`è¾“å…¥æ–°${val.label}`}
                                                    />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* å³ä¾§ */}
                            <div className="lg:col-span-5 space-y-6">
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 h-full flex flex-col">
                                    <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-2">ç¬¬ä¸‰æ­¥ï¼šè®®é¢˜ä¸æ­£æ–‡</h3>
                                    
                                    <textarea 
                                        value={inputText} 
                                        onChange={e=>setInputText(e.target.value)} 
                                        className="w-full h-32 p-3 border rounded text-sm font-mono shadow-inner mb-2"
                                        placeholder="è¯·åœ¨æ­¤è¾“å…¥ã€æ–°è®®é¢˜ã€‘åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª)..."
                                    />
                                    
                                    {/* ä»£ç†é€‰æ‹©å™¨ */}
                                    <div className="mb-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                                        <div className="text-xs font-bold text-gray-700 mb-2">é€‰æ‹©è¿æ¥çº¿è·¯ (è‹¥å¤±è´¥è¯·åˆ‡æ¢):</div>
                                        <div className="flex flex-wrap gap-2 mb-2">
                                            <label className="flex items-center cursor-pointer text-xs bg-white px-2 py-1 rounded border">
                                                <input type="radio" name="proxy" checked={proxyService === "lineA"} onChange={() => setProxyService("lineA")} className="mr-1"/>
                                                çº¿è·¯A (Heroku/ç¨³å®š/éœ€æ¿€æ´»)
                                            </label>
                                            <label className="flex items-center cursor-pointer text-xs bg-white px-2 py-1 rounded border">
                                                <input type="radio" name="proxy" checked={proxyService === "lineB"} onChange={() => setProxyService("lineB")} className="mr-1"/>
                                                çº¿è·¯B (CorsProxy)
                                            </label>
                                            <label className="flex items-center cursor-pointer text-xs bg-white px-2 py-1 rounded border">
                                                <input type="radio" name="proxy" checked={proxyService === "lineC"} onChange={() => setProxyService("lineC")} className="mr-1"/>
                                                çº¿è·¯C (ThingProxy)
                                            </label>
                                            <label className="flex items-center cursor-pointer text-xs bg-white px-2 py-1 rounded border">
                                                <input type="radio" name="proxy" checked={proxyService === "direct"} onChange={() => setProxyService("direct")} className="mr-1"/>
                                                ç›´è¿ (éœ€æ’ä»¶)
                                            </label>
                                        </div>
                                        
                                        {proxyService === "lineA" && (
                                            <div className="text-xs text-blue-600 bg-blue-50 p-2 rounded">
                                                <span className="font-bold">ğŸ”´ å¿…åšï¼šé¦–æ¬¡ä½¿ç”¨è¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æ¿€æ´»ï¼š</span><br/>
                                                <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="underline font-bold text-red-600 text-sm">
                                                    ğŸ‘‰ ç‚¹æ­¤æ¿€æ´»çº¿è·¯A
                                                </a>
                                                <span className="ml-1 text-gray-500">(åœ¨æ–°é¡µé¢ç‚¹æŒ‰é’®å³å¯)</span>
                                            </div>
                                        )}
                                    </div>

                                    <button 
                                        onClick={handleGenerateAI}
                                        disabled={isLoading}
                                        className={`w-full py-2 text-white font-bold rounded shadow mb-4 ${isLoading ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700'}`}
                                    >
                                        {isLoading ? <div className="loader mx-auto"></div> : "AI ç”Ÿæˆæ­£æ–‡ (Qwen-max)"}
                                    </button>

                                    <textarea 
                                        value={generatedContent} 
                                        readOnly
                                        className="w-full flex-grow p-3 border rounded text-sm font-mono bg-white mb-4 min-h-[150px]"
                                        placeholder="ç”Ÿæˆç»“æœ..."
                                    />

                                    <button 
                                        onClick={exportDoc}
                                        disabled={!templateBuffer}
                                        className={`w-full py-4 text-white font-bold text-xl rounded shadow ${!templateBuffer ? 'bg-gray-300' : 'bg-green-600 hover:bg-green-700'}`}
                                    >
                                        ğŸ“¥ å¯¼å‡º (æ ·å¼ç»§æ‰¿ç»ˆæç‰ˆ)
                                    </button>
                                    <p className="text-center text-xs text-red-500 mt-2 font-bold">{statusMsg}</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
