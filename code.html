<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…šæ€»æ”¯ä¼šè®®çºªè¦æ™ºèƒ½ç”Ÿæˆç³»ç»Ÿ (æ¯ç‰ˆå¼ºåŠ›æ›¿æ¢ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        body { font-family: 'Noto Serif SC', serif; background-color: #f3f4f6; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #b91c1c;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input.custom-input { width: 100%; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; border-radius: 0.375rem; }
        input.custom-input:focus { border-color: #ef4444; outline: none; ring: 1px solid #ef4444; }
        .arrow-icon { color: #9ca3af; margin: 0 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼šè®®çºªè¦æ’°å†™åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä¸‹åˆ—è§„åˆ™ç”Ÿæˆä¼šè®®çºªè¦æ­£æ–‡ï¼š
ã€ç¼–å·ä¸æ ¼å¼ã€‘
- æ‰€æœ‰çºªè¦æ¡ç›®ä½¿ç”¨ä¸­æ–‡æ•°å­—ï¼ˆä¸€ã€äºŒã€ä¸‰â€¦â€¦ï¼‰ç¼–å·ï¼Œå•ç‹¬æˆæ®µã€‚
- ä¸è¦ä½¿ç”¨ Markdown æ ¼å¼ï¼Œåªè¾“å‡ºçº¯æ–‡æœ¬ã€‚
ã€åŠ¨è¯è½¬æ¢ä½“ç³»ã€‘
- å¸¸è§åŠ¨è¯ï¼šå®¡è®®ï¼ˆè½¬æ¢ä¸ºï¼šä¼šè®®åŒæ„ï¼‰ã€å¬å–ï¼ˆè½¬æ¢ä¸ºï¼šä¼šè®®åŒæ„æˆ–ä¼šè®®å¬å–ï¼‰ã€å­¦ä¹ ï¼ˆè½¬æ¢ä¸ºï¼šä¼šè®®å­¦ä¹ äº†ï¼‰
- å¿…é¡»è½¬æ¢ï¼šå¦‚æœåŸæ–‡æ˜¯â€œå®¡è®®ã€ŠXXXã€‹â€ï¼Œçºªè¦ä¸­å¿…é¡»å†™â€œä¼šè®®å®¡è®®ã€ŠXXXã€‹ã€‚ä¼šè®®åŒæ„è¯¥...â€ã€‚
ã€å†³è®®ä¸ä»»åŠ¡åˆ†é…ã€‘
- å¸¸ç”¨å†³è®®ï¼šä¼šè®®åŒæ„ã€ä¼šè®®è¦æ±‚ã€‚
- å¸¸ç”¨ä»»åŠ¡åˆ†é…ï¼šè¦æ±‚ç»¼åˆåŠå…¬å®¤ï¼ˆç»å¤§å¤šæ•°æƒ…å†µï¼‰ã€æè¯·åŠå…¬ä¼šè®®å®¡è®®ã€‚
- ç¦æ­¢å†™â€œå„éƒ¨é—¨â€ï¼Œåªèƒ½å†™â€œç»¼åˆåŠå…¬å®¤â€æˆ–â€œè®¡åˆ’è´¢åŠ¡éƒ¨â€ã€‚
ã€ä¸‰æ®µå¼ç»“æ„ã€‘
- æ¯æ¡çºªè¦åº”åŒ…å«ï¼š
  1. åŠ¨è¯è½¬æ¢åçš„è®®é¢˜å¤è¿°
  2. æ˜ç¡®çš„ä¼šè®®å†³è®®
  3. æ¸…æ™°çš„ä»»åŠ¡åˆ†é…ä¸è¦æ±‚
è¯·åªè¾“å‡ºç”Ÿæˆçš„æ­£æ–‡å†…å®¹ï¼Œä¸è¦åŒ…å«æ ‡é¢˜ã€åŸºæœ¬ä¿¡æ¯æˆ–è®®é¢˜åˆ—è¡¨ã€‚`;

        const App = () => {
            const apiKey = ""; 
            
            // æ›¿æ¢å¯¹ï¼š{ key: { old: string, new: string, label: string } }
            const [replaceMap, setReplaceMap] = useState({
                issue: { label: "æ–‡å·", old: "", new: "2025ï¼16" },
                date: { label: "æ—¥æœŸ", old: "", new: new Date().toLocaleDateString('zh-CN', {year:'numeric', month:'long', day:'numeric'}) },
                time: { label: "æ—¶é—´", old: "", new: "" },
                location: { label: "åœ°ç‚¹", old: "", new: "" },
                attendees: { label: "å‡ºå¸­", old: "", new: "" },
                nonvoting: { label: "åˆ—å¸­", old: "", new: "" },
                host: { label: "ä¸»æŒ", old: "", new: "" },
                recorder: { label: "è®°å½•", old: "", new: "" },
            });

            const [inputText, setInputText] = useState("");
            const [generatedContent, setGeneratedContent] = useState("");
            
            const [templateBuffer, setTemplateBuffer] = useState(null);
            const [fileName, setFileName] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState("è¯·å…ˆä¸Šä¼ æ—§æ–‡æ¡£ä½œä¸ºæ¯ç‰ˆ");

            // è¾…åŠ©ï¼šæ›´æ–° Map
            const updateMap = (key, field, val) => {
                setReplaceMap(prev => ({
                    ...prev,
                    [key]: { ...prev[key], [field]: val }
                }));
            };

            // 1. è¯»å–å¹¶è§£ææ—§æ–‡æ¡£
            const handleParseOldDoc = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setFileName(file.name);
                setStatusMsg("æ­£åœ¨æ·±åº¦è§£ææ—§æ–‡æ¡£...");
                
                const arrayBuffer = await file.arrayBuffer();
                setTemplateBuffer(arrayBuffer);

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const result = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                        const text = result.value;
                        
                        // æå–å‡½æ•°
                        const extract = (regex) => {
                            const match = text.match(regex);
                            return match ? match[1].trim() : "";
                        };

                        const newMap = { ...replaceMap };
                        
                        // è‡ªåŠ¨å¡«å…¥â€œæ—§å†…å®¹â€å’Œâ€œæ–°å†…å®¹â€çš„é»˜è®¤å€¼
                        const setVal = (key, regex) => {
                            const val = extract(regex);
                            if (val) {
                                newMap[key].old = val;
                                newMap[key].new = val; // é»˜è®¤æ–°å†…å®¹ç­‰äºæ—§å†…å®¹ï¼Œæ–¹ä¾¿ä¿®æ”¹
                            }
                        };

                        setVal('issue', /ï¼ˆ(20\d\d[ï¼-]\d+)ï¼‰/);
                        setVal('date', /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)/);
                        setVal('time', /æ—¶é—´[ï¼š:]\s*(.*)/);
                        setVal('location', /åœ°ç‚¹[ï¼š:]\s*(.*)/);
                        setVal('attendees', /å‡ºå¸­[ï¼š:]\s*(.*)/);
                        setVal('nonvoting', /åˆ—å¸­[ï¼š:]\s*(.*)/);
                        setVal('host', /ä¸»æŒ[ï¼š:]\s*(.*)/);
                        setVal('recorder', /è®°å½•[ï¼š:]\s*(.*)/);

                        setReplaceMap(newMap);
                        setStatusMsg("âœ… æ¯ç‰ˆåŠ è½½æˆåŠŸï¼è¯·åœ¨ä¸‹æ–¹ç¡®è®¤ã€æ—§å†…å®¹ã€‘å¹¶è¾“å…¥ã€æ–°å†…å®¹ã€‘ã€‚");
                    } catch (error) {
                        console.error(error);
                        setStatusMsg("âŒ è§£æå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æ—§å†…å®¹ã€‚");
                    }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = null;
            };

            // 2. AI ç”Ÿæˆ
            const handleGenerateAI = async () => {
                if (!inputText.trim()) { alert("è¯·è¾“å…¥è®®é¢˜å†…å®¹ï¼"); return; }
                setIsLoading(true);
                setStatusMsg("AI æ­£åœ¨æ’°å†™çºªè¦...");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `ã€å®é™…ä¼šè®®è®®é¢˜å†…å®¹ã€‘\n${inputText}` }] }],
                            systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
                        })
                    });
                    const data = await response.json();
                    if (response.ok && data.candidates) {
                        setGeneratedContent(data.candidates[0].content.parts[0].text);
                        setStatusMsg("âœ… AI ç”Ÿæˆå®Œæˆï¼è¯·ç‚¹å‡»å¯¼å‡ºã€‚");
                    } else throw new Error("API Error");
                } catch (error) {
                    console.error(error);
                    setStatusMsg("ç”Ÿæˆå¤±è´¥");
                } finally { setIsLoading(false); }
            };

            // 3. æ ¸å¿ƒï¼šXML ç©¿é€æ›¿æ¢ç®—æ³•
            const escapeRegExp = (string) => {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            };

            // æ„é€ èƒ½å¿½ç•¥ XML æ ‡ç­¾çš„æ­£åˆ™
            // ä¾‹å¦‚ï¼šæŠŠ "2025" å˜æˆ "2(?:<[^>]+>)*0(?:<[^>]+>)*2(?:<[^>]+>)*5"
            const createXmlRegex = (plainText) => {
                if (!plainText) return null;
                const chars = plainText.split('');
                const pattern = chars.map(c => escapeRegExp(c)).join('(?:<[^>]+>)*');
                return new RegExp(pattern, 'g');
            };

            const exportDoc = () => {
                if (!templateBuffer) { alert("è¯·å…ˆä¸Šä¼ æ¯ç‰ˆï¼"); return; }
                
                try {
                    const zip = new window.PizZip(templateBuffer);
                    
                    // è·å–æ ¸å¿ƒ XML
                    let xml = zip.file("word/document.xml").asText();

                    // --- æ›¿æ¢åŸºç¡€ä¿¡æ¯ ---
                    Object.values(replaceMap).forEach(item => {
                        if (item.old && item.new && item.old !== item.new) {
                            const regex = createXmlRegex(item.old);
                            if (regex) {
                                xml = xml.replace(regex, item.new);
                            }
                        }
                    });

                    // --- æ›¿æ¢æ­£æ–‡ (è¿½åŠ æ¨¡å¼) ---
                    if (generatedContent) {
                        const regexOne = createXmlRegex("ä¸€ã€");
                        if (regexOne && regexOne.test(xml)) {
                             alert(âš ï¸ æç¤ºï¼šç³»ç»Ÿå·²æ›´æ–°åŸºç¡€ä¿¡æ¯ï¼ˆæ—¥æœŸã€æ–‡å·ç­‰ï¼‰ã€‚\n\nå…³äºæ­£æ–‡ï¼šç”±äºæ—§æ–‡æ¡£çš„æ­£æ–‡ä½ç½®å¤æ‚ï¼Œè¯·åœ¨å¯¼å‡ºåå°†æ–°ç”Ÿæˆçš„æ­£æ–‡å¤åˆ¶è¿›å»ã€‚");
                        } else {
                             alert("âš ï¸ æç¤ºï¼šæ–‡æ¡£åŸºç¡€ä¿¡æ¯å·²æ›´æ–°ã€‚\n\nè¯·æ‰‹åŠ¨å°† AI ç”Ÿæˆçš„æ­£æ–‡ç²˜è´´åˆ°æ–‡æ¡£åˆé€‚ä½ç½®ã€‚");
                        }
                    }

                    zip.file("word/document.xml", xml);
                    const blob = zip.generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                    saveAs(blob, `ä¼šè®®çºªè¦_${replaceMap.issue.new}.docx`);
                    setStatusMsg("ğŸ‰ å¯¼å‡ºæˆåŠŸï¼");
                    
                    // ä¿®å¤ï¼šç§»é™¤è‡ªåŠ¨å‰ªè´´æ¿å†™å…¥ä»¥é˜²æ­¢é”™è¯¯
                    // navigator.clipboard.writeText(generatedContent).catch(err => console.log('Clipboard write failed', err));

                } catch (e) {
                    console.error(e);
                    alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•");
                }
            };

            return (
                <div className="max-w-7xl mx-auto p-6 min-h-screen text-gray-800 font-sans">
                    <div className="bg-white p-8 rounded-xl shadow-xl border border-gray-200">
                        <div className="flex justify-between items-center border-b pb-4 mb-6">
                            <h1 className="text-2xl font-bold text-red-700">å…šæ€»æ”¯ä¼šè®®çºªè¦ç³»ç»Ÿ (æ¯ç‰ˆå¼ºåŠ›æ›¿æ¢ç‰ˆ)</h1>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* å·¦ä¾§ï¼šæ¯ç‰ˆä¸æ›¿æ¢è®¾ç½® */}
                            <div className="lg:col-span-7 space-y-6">
                                {/* ä¸Šä¼ åŒº */}
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-blue-800 text-lg">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ—§æ–‡æ¡£æ¯ç‰ˆ</h3>
                                        <p className="text-xs text-blue-600">{fileName ? `å½“å‰æ¯ç‰ˆï¼š${fileName}` : "è¯·ä¸Šä¼ ä¸Šæ¬¡çš„ .docx æ–‡ä»¶ï¼Œç³»ç»Ÿå°†ä¿ç•™å…¶æ ¼å¼"}</p>
                                    </div>
                                    <label className="cursor-pointer bg-white text-blue-700 border border-blue-300 px-4 py-2 rounded shadow hover:bg-blue-50 font-bold text-sm">
                                        ğŸ“‚ ç‚¹å‡»ä¸Šä¼ 
                                        <input type="file" className="hidden" onChange={handleParseOldDoc} accept=".docx"/>
                                    </label>
                                </div>

                                {/* æ›¿æ¢æ˜ å°„è¡¨ */}
                                <div className="bg-white border border-gray-200 rounded-lg p-4">
                                    <h3 className="font-bold text-gray-700 mb-3 border-l-4 border-red-500 pl-2">ç¬¬äºŒæ­¥ï¼šç¡®è®¤æ›¿æ¢å†…å®¹</h3>
                                    <p className="text-xs text-gray-500 mb-4">ç³»ç»Ÿè‡ªåŠ¨è¯»å–äº†å·¦è¾¹çš„ã€æ—§å†…å®¹ã€‘ï¼Œè¯·åœ¨å³è¾¹è¾“å…¥æœ¬æœŸçš„ã€æ–°å†…å®¹ã€‘ã€‚</p>
                                    
                                    <div className="grid grid-cols-1 gap-3 max-h-[400px] overflow-y-auto pr-2">
                                        {Object.entries(replaceMap).map(([key, val]) => (
                                            <div key={key} className="flex items-center bg-gray-50 p-2 rounded">
                                                <div className="w-16 text-xs font-bold text-gray-600">{val.label}</div>
                                                <div className="flex-1">
                                                    <div className="text-xs text-gray-400 mb-1">æ—§: {val.old || "(æœªæ‰¾åˆ°)"}</div>
                                                    <input 
                                                        className="custom-input h-8 text-sm" 
                                                        value={val.new} 
                                                        onChange={(e) => updateMap(key, 'new', e.target.value)}
                                                        placeholder={`è¾“å…¥æ–°${val.label}`}
                                                    />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* å³ä¾§ï¼šæ­£æ–‡ç”Ÿæˆä¸å¯¼å‡º */}
                            <div className="lg:col-span-5 space-y-6">
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 h-full flex flex-col">
                                    <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-2">ç¬¬ä¸‰æ­¥ï¼šè®®é¢˜ä¸æ­£æ–‡</h3>
                                    
                                    <textarea 
                                        value={inputText} 
                                        onChange={e=>setInputText(e.target.value)} 
                                        className="w-full h-32 p-3 border rounded text-sm font-mono shadow-inner mb-2"
                                        placeholder="åœ¨æ­¤è¾“å…¥æ–°è®®é¢˜..."
                                    />
                                    <button 
                                        onClick={handleGenerateAI}
                                        disabled={isLoading}
                                        className={`w-full py-2 text-white font-bold rounded shadow mb-4 ${isLoading ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700'}`}
                                    >
                                        {isLoading ? <div className="loader mx-auto"></div> : "AI ç”Ÿæˆæ­£æ–‡"}
                                    </button>

                                    <textarea 
                                        value={generatedContent} 
                                        readOnly
                                        className="w-full flex-grow p-3 border rounded text-sm font-mono bg-white mb-4 min-h-[150px]"
                                        placeholder="ç”Ÿæˆç»“æœ..."
                                    />

                                    <button 
                                        onClick={exportDoc}
                                        disabled={!templateBuffer}
                                        className={`w-full py-4 text-white font-bold text-xl rounded shadow ${!templateBuffer ? 'bg-gray-300' : 'bg-green-600 hover:bg-green-700'}`}
                                    >
                                        ğŸ“¥ å¯¼å‡ºå¹¶æ›¿æ¢
                                    </button>
                                    <p className="text-center text-xs text-gray-400 mt-2">{statusMsg}</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>